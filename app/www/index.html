<!DOCTYPE html>

<html dir="ltr">

	<head>
		<title>Intuit Boot Camp Demonstrations</title>
		<link href='libs/bootstrap/dist/css/bootstrap.min.css' rel="stylesheet">
		<link href='libs/bootstrap/dist/css/bootstrap-theme.min.css' rel="stylesheet">
		<link href='css/site.css' rel="stylesheet">
	</head>

	<body>
		<button id="log-me-in">Log Me In</button><button id="add-transaction">Add Transaction</button>
		<script src="libs/jquery/dist/jquery.js"></script>
		<script src="libs/bootstrap/dist/js/bootstrap.js"></script>
		<script src="libs/underscore/underscore.js"></script>
		<script src="libs/backbone/backbone.js"></script>
		<script>

			var BaseModel = Backbone.Model.extend({
				sync: function(method, model, options) {
					if (!options) {
						options = {};
					}
					options.beforeSend = function(xhr) {
						xhr.setRequestHeader("X-CSRF-Token", window.csrfToken);
					};
					Backbone.sync.call(this, method, model, options)
						.then(function(data, status, xhr) {
							window.csrfToken = xhr.getResponseHeader("X-CSRF-Token");
						});
				},
				idAttribute: "_id"
			});

			var Transaction = BaseModel.extend({
				urlRoot: "/api/transaction",
				defaults: {
					accountNumber: null,
					payee: null,
					taxItem: "No Tax Item 2",
					amount: null,
					description: null
				},
			});

			window.addEventListener("DOMContentLoaded", function() {

				document.getElementById("log-me-in")
					.addEventListener("click", function() {

						var xhr = new XMLHttpRequest();
						xhr.onreadystatechange = function() {
							if (xhr.readyState === 4) {

								window.csrfToken = xhr.getResponseHeader("X-CSRF-Token");

							}
						}

						xhr.open("POST", "/api/accounts/authenticate");
						xhr.send(JSON.stringify({
							"username": "testuser",
  						"password": "123"
						}))

				});

				document.getElementById("add-transaction")
					.addEventListener("click", function() {

						var t = new Transaction({});
						t.set("accountNumber", 345);
						t.set("payee", "Intuit");
						t.set("taxItem", "Payroll");
						t.set("amount", 230);
						t.set("description", "Because I love paying people...");
						t.save(null, {
							success: function() {
								console.dir(t.attributes);
							}
						});

				});

			});





		</script>
	</body>

</html>
